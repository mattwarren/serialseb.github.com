---
layout: post
title: Making the case against OnXxx
date: '2008-02-07T11:25:00.001Z'

tags: 
modified_time: '2008-02-07T23:09:16.277Z'
blogger_id: tag:blogger.com,1999:blog-4015568221071268916.post-7681265354320504493
comments: true
blogger_orig_url: http://serialseb.blogspot.com/2008/02/raising-event-without-checking-for-null.html
---

<p>[Updated the code sample for the raising event method. See my <a href="http://serialseb.blogspot.com/2008/02/follow-up-on-onxxx-anti-pattern.html">response to the comments that were made</a>.]</p>  <p>Some people, like Jeremy, really don't like events. I have to admit having a nearly-fanatic interest in good event patterns. One of such patterns I've seen used and misused continuously is the OnXxx pattern. Let's have a quick look at what the MSDN gods have to say about this.</p>  <blockquote>   <p>You raise the event by calling the protected <b>On</b><i>EventName</i> method in the class that defined the event, or in a derived class. The <b>On</b><i>EventName </i>method raises the event by invoking the delegates, passing in any event-specific data. The delegate methods for the event can perform actions for the event or process the event-specific data.</p>    <p><b>Note:        <br /></b>The protected <b>On</b><i>EventName </i>method also allows derived classes to override the event without attaching a delegate to it. A derived class must always call the <b>On</b><i>EventName </i>method of the base class to ensure that registered delegates receive the event.</p>    <p>When you want to handle events raised in another class, you add delegate methods to the event.</p> </blockquote>  <p>So far so good. Let's open reflector and check how well is this pattern implemented. First candidate (selected through my advanced AI randomisation algorythm called <em>click until you find a class with an OnXxx patern</em>), <a href="http://msdn2.microsoft.com/System.IO.FileSystemWatcher">FileSystemWatcher</a>.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">void</span> OnChanged(FileSystemEventArgs e)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; FileSystemEventHandler onChangedHandler = <span style="color: blue">this</span>.onChangedHandler;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (onChangedHandler != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">if</span> ((<span style="color: blue">this</span>.SynchronizingObject != <span style="color: blue">null</span>) &amp;&amp; <span style="color: blue">this</span>.SynchronizingObject.InvokeRequired)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.SynchronizingObject.BeginInvoke(onChangedHandler, <span style="color: blue">new</span> <span style="color: blue">object</span>[] { <span style="color: blue">this</span>, e });</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">else</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; onChangedHandler(<span style="color: blue">this</span>, e);</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>So far so good. Let's stay within mscorlib (just in case the pattern was team specific), and have a look at <a href="http://msdn2.microsoft.com/System.Collections.DictionaryBase">DictionaryBase</a>.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> OnClear()</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">}</p> </div>  <p>Oh. Where's the event call? Let's see what the method is described as doing.</p>  <blockquote>   <p>Performs additional custom processes before clearing the contents of the DictionaryBase instance.</p> </blockquote>  <p>Wait a second, I thought we were supposed to use OnXxx for <strong>raising</strong> events, not to change stuff. Ok, let's move on to the ado.net team, and have a look at <a href="http://msdn2.microsoft.com/System.Data.DataSet">DataSet</a>, and for the same price I give you not one but two methods.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">internal</span> <span style="color: blue">void</span> RaisePropertyChanging(<span style="color: blue">string</span> name)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">this</span>.OnPropertyChanging(<span style="color: blue">new</span> <span style="color: #2b91af">PropertyChangedEventArgs</span>(name));</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> OnPropertyChanging(<span style="color: #2b91af">PropertyChangedEventArgs</span> pcevent)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (<span style="color: blue">this</span>.onPropertyChangingDelegate != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.onPropertyChangingDelegate(<span style="color: blue">this</span>, pcevent);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">} </p> </div>  <p>Alright... Now I'm getting quite confused. I can call RaiseXxx(name) which in turns call the proper OnXxx pattern that calls the event. This is now getting quite messy. Let's see what the guys in the asp.net team do with the <a href="http://msdn2.microsoft.com/System.Web.UI.DataSourceControl">DataSourceControl</a>.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> RaiseDataSourceChangedEvent(<span style="color: #2b91af">EventArgs</span> e)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">this</span>.OnDataSourceChangedInternal(e);</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">this</span>.OnDataSourceChanged(e);</p>    <p style="margin: 0px">}</p> </div>  <p>Note that both OnXxx are now private methods... At least in DataSet you have two ways to do the same thing, one legal and one not legal (again, according to the msdn documentation). Not convinced yet? Ok, let's see what the Winforms guy have been doing and have a look at <a href="http://msdn2.microsoft.com/System.Windows.Forms.Control">Control</a>. I'll point to two examples.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px">[<span style="color: #2b91af">EditorBrowsable</span>(<span style="color: #2b91af">EditorBrowsableState</span>.Advanced)]</p>    <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> OnNotifyMessage(Message m)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">}</p> </div>  <p>And example 2.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px">[<span style="color: #2b91af">EditorBrowsable</span>(<span style="color: #2b91af">EditorBrowsableState</span>.Advanced)]</p>    <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">void</span> RaisePaintEvent(<span style="color: blue">object</span> key, PaintEventArgs e)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; PaintEventHandler handler = (PaintEventHandler)<span style="color: blue">base</span>.Events[EventPaint];</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (handler != <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; handler(<span style="color: blue">this</span>, e);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">}</p> </div>  <p>Note that the OnPaint event exists and does mostly the same thing. Isn't it great to have that much flexibility? Ok, last but not least, let's see what the latest greatest brings us with WPF's <a href="http://msdn2.microsoft.com/System.Windows.UIElement">UIElement</a>.</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">void</span> RaiseEvent(RoutedEventArgs e)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">if</span> (e == <span style="color: blue">null</span>)</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">throw</span> <span style="color: blue">new</span> <span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;e&quot;</span>);</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; e.ClearUserInitiated();</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">this</span>.RaiseEventImpl(e);</p>    <p style="margin: 0px">}</p>    <p style="margin: 0px"><span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> OnMouseLeave(MouseEventArgs e)</p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">}</p> </div>  <p>Can you make any sense of the OnXxx notation? No? Me neither, neither do my developers. So I hereby propose (again) to just get done with it already and *<strong>aknowledge</strong>* that OnXxx is an anti-pattern used either for raising or for handling events, is overused and misused, and should die a long and painful death. I propose the simpler and more semantically correct syntax:</p>  <div style="border-right: black 1px dashed; padding-right: 5px; border-top: black 1px dashed; padding-left: 5px; font-size: 10pt; background: rgb(234,234,234); padding-bottom: 5px; border-left: black 1px dashed; color: black; padding-top: 5px; border-bottom: black 1px dashed; font-family: consolas, courier new">   <p style="margin: 0px"><span style="color: blue">public</span> <span style="color: blue">class</span> <span style="color: #2b91af">DoingEventsProperly</span></p>    <p style="margin: 0px">{</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> DoingEventsProperly()</p>    <p style="margin: 0px">&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: blue">this</span>.SomethingChanged += HandleSomethingChangedEvent;</p>    <p style="margin: 0px">&#160;&#160;&#160; }</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">public</span> <span style="color: blue">event</span> <span style="color: #2b91af">EventHandler</span>&lt;<span style="color: #2b91af">PropertyChangedEventArgs</span>&gt; SomethingChanged = (src, ea) =&gt; { };</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> Raise<em>SomethingChanged</em>Event(<span style="color: #2b91af">PropertyChangedEventArgs</span> e) { SomethingChanged(<span style="color: blue">this</span>, <span style="color: blue">e</span>); }</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160; <span style="color: blue">protected</span> <span style="color: blue">virtual</span> <span style="color: blue">void</span> Handle<em>SomethingChanged</em>Event(<span style="color: blue">object</span> src, <span style="color: #2b91af">PropertyChangedEventArgs</span> ea) { }</p>    <p style="margin: 0px">}</p> </div>  <p>What this class achieves is covering all the scenarios we just encountered.</p>  <ul>   <li>The event handler is defaulted to an empty anonymous method, so it cannot be null, which means RaiseSomethingChangedEvent doesn't need to check for null. </li>    <li>The semantic of the RaiseXxxEvent method is simple: It raises the event. Want to cancel the event? Override RaiseXxxEvent. </li>    <li>The semantic of HandleXxxEvent is simple: It aint raising the event! Want to do some stuff in your class when the event is raised, override that method. </li> </ul>  <p>And it's also easy to explain: Call it <strong>Raise</strong> when you're <strong>Raising</strong> an event and call it <strong>Handle</strong> if you're <strong>handling</strong> an event. I think the semantic complexity is achievable.</p>  <p>I may go into the other patterns such as explicitly cancelable events for consumers and explicitly cancelable by contract for inheritance cancellation another day.</p>  <p>And remember: <strong>The best way to combat an anti-pattern is to stop using it.</strong></p>  <div class="wlWriterSmartContent" id="scid:0767317B-992E-4b12-91E0-4F059A8CECA8:60eca767-68e8-437d-94f4-820fd5a7827e" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati Tags: <a href="http://technorati.com/tags/alt.net" rel="tag">alt.net</a>,<a href="http://technorati.com/tags/c#" rel="tag">c#</a>,<a href="http://technorati.com/tags/events" rel="tag">events</a>,<a href="http://technorati.com/tags/patterns" rel="tag">patterns</a>,<a href="http://technorati.com/tags/anti-patterns" rel="tag">anti-patterns</a></div>  