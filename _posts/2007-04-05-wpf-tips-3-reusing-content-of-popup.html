---
layout: post
title: 'WPF Tips''n''Tricks #3: Reusing the content of a Popup control'
date: '2007-04-05T15:25:00.001+01:00'
author: Sebastien Lambla
tags: 
modified_time: '2007-04-05T15:25:44.216+01:00'
blogger_id: tag:blogger.com,1999:blog-4015568221071268916.post-2251941646740880384
blogger_orig_url: http://serialseb.blogspot.com/2007/04/wpf-tips-3-reusing-content-of-popup.html
---

<p>That one is far from obvious, and is what I'd classify as a bug. As soon as Microsoft fix the Connect web-site to let us report RTM bugs, I'll more than happily fill one up.</p> <p>In WPF, controls can only have one parent at a time. Because rendering is done top down and every control has a sequence of Measure/Arrange calls to define the layout of the windows, it makes perfect sense.</p> <p>It also makes perfect sense to be able to remove a control from somewhere (let's say a Button from a Panel) and re-add it somewhere else. Quick and dirty example, a button switching between two panels.</p> <div style="font-size: 10pt; background: white; color: black; font-family: consolas, courier new"> <p style="margin: 0px"><span style="color: blue">&lt;</span><span style="color: #a31515">Window</span><span style="color: blue"> </span><span style="color: red">x:Class</span><span style="color: blue">=</span>"<span style="color: blue">PopupExample.Window1</span>"</p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; </span><span style="color: red">xmlns</span><span style="color: blue">=</span>"<span style="color: blue">http://schemas.microsoft.com/winfx/2006/xaml/presentation</span>"</p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; </span><span style="color: red">xmlns:x</span><span style="color: blue">=</span>"<span style="color: blue">http://schemas.microsoft.com/winfx/2006/xaml</span>"</p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; </span><span style="color: red">xmlns:my</span><span style="color: blue">=</span>"<span style="color: blue">clr-namespace:IsDirtyExample</span>"<span style="color: blue"> </span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; </span><span style="color: red">Title</span><span style="color: blue">=</span>"<span style="color: blue">IsDirtyExample</span>"<span style="color: blue"> </span><span style="color: red">SizeToContent</span><span style="color: blue">=</span>"<span style="color: blue">WidthAndHeight</span>"<span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">DockPanel</span><span style="color: blue"> </span><span style="color: red">LastChildFill</span><span style="color: blue">=</span>"<span style="color: blue">False</span>"<span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">DockPanel</span><span style="color: blue"> </span><span style="color: red">DockPanel.Dock</span><span style="color: blue">=</span>"<span style="color: blue">Top</span>"<span style="color: blue"> </span><span style="color: red">Name</span><span style="color: blue">=</span>"<span style="color: blue">FirstGrid</span>"<span style="color: blue"> </span><span style="color: red">Background</span><span style="color: blue">=</span>"<span style="color: blue">Orange</span>"<span style="color: blue"> </span><span style="color: red">Width</span><span style="color: blue">=</span>"<span style="color: blue">250</span>"<span style="color: blue"> </span><span style="color: red">Height</span><span style="color: blue">=</span>"<span style="color: blue">200</span>"<span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">Button</span><span style="color: blue"> </span><span style="color: red">Name</span><span style="color: blue">=</span>"<span style="color: blue">OneButtonToRuleThemAll</span>"<span style="color: blue">&gt;</span>Ding<span style="color: blue">&lt;/</span><span style="color: #a31515">Button</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">DockPanel</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">DockPanel</span><span style="color: blue"> </span><span style="color: red">DockPanel.Dock</span><span style="color: blue">=</span>"<span style="color: blue">Top</span>"<span style="color: blue"> </span><span style="color: red">Name</span><span style="color: blue">=</span>"<span style="color: blue">SecondGrid</span>"<span style="color: blue"> </span><span style="color: red">Background</span><span style="color: blue">=</span>"<span style="color: blue">OrangeRed</span>"<span style="color: blue"> </span><span style="color: red">Width</span><span style="color: blue">=</span>"<span style="color: blue">250</span>"<span style="color: blue"> </span><span style="color: red">Height</span><span style="color: blue">=</span>"<span style="color: blue">200</span>"<span style="color: blue">&gt;&lt;/</span><span style="color: #a31515">DockPanel</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;</span><span style="color: #a31515">Button</span><span style="color: blue"> </span><span style="color: red">DockPanel.Dock</span><span style="color: blue">=</span>"<span style="color: blue">Top</span>"<span style="color: blue"> </span><span style="color: red">Click</span><span style="color: blue">=</span>"<span style="color: blue">HandleMoveClick</span>"<span style="color: blue">&gt;</span>Move the Ding!<span style="color: blue">&lt;/</span><span style="color: #a31515">Button</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&nbsp;&nbsp;&nbsp; &lt;/</span><span style="color: #a31515">DockPanel</span><span style="color: blue">&gt;</span></p> <p style="margin: 0px"><span style="color: blue">&lt;/</span><span style="color: #a31515">Window</span><span style="color: blue">&gt;</span></p></div> <div style="font-size: 10pt; background: white; color: black; font-family: consolas, courier new"> <p style="margin: 0px"><span style="color: blue">namespace</span> PopupExample</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">partial</span> <span style="color: blue">class</span> <span style="color: #2b91af">Window1</span> : System.Windows.<span style="color: #2b91af">Window</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> Window1()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InitializeComponent();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">void</span> HandleMoveClick(<span style="color: blue">object</span> source, <span style="color: #2b91af">RoutedEventArgs</span> e)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FirstGrid.Children.Remove(OneButtonToRuleThemAll);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SecondGrid.Children.Add(OneButtonToRuleThemAll);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">}</p></div> <p>When you create a Popup control however, it only has a Child property. So you'd assume you would just change the Child property to a new control, and that new control would then be showing next time you open the Popup, and the old control wouldn't be in any visual tree anymore. Well, it doesn't always&nbsp;happen that way at all.</p> <p>If your Popup is visible, then you'll see the change. If the Popup is not visible anymore, and you set it's&nbsp;Child property to null, and reattach your control to a new Popup, you'll be greeted by a very useful message.</p> <blockquote> <p>Must disconnect specified child from current parent Visual before attaching to new parent Visual.</p></blockquote> <p>But wait, the control is not&nbsp;assigned to the Child property anymore? It is and it is not. Whenever the popup gets created, it keeps a separate object deep within called a PopupRoot. That one gets created once and has as a child the control pointed by the Popup's Child property. But whenever a popup is closed (IsOpened=false), changes to its Child property will not impact the PopupRoot that still has a reference to the previous value. Hence why when you try to add your control somewhere else, you have an exception</p> <p>The solution? Put as the first child of your popup a neutral panel (Grid for example), and move your controls around only as a child of that grid. Full code sample shown below.</p> <div style="font-size: 10pt; background: white; color: black; font-family: consolas, courier new"> <p style="margin: 0px"><span style="color: blue">namespace</span> PopupExample</p> <p style="margin: 0px">{</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> <span style="color: blue">partial</span> <span style="color: blue">class</span> <span style="color: #2b91af">Window1</span> : System.Windows.<span style="color: #2b91af">Window</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">public</span> Window1()</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; InitializeComponent();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> button_Click(<span style="color: blue">object</span> sender, <span style="color: #2b91af">RoutedEventArgs</span> e)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">if</span> (popupButton == <span style="color: blue">null</span>)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popupButton = <span style="color: blue">new</span> <span style="color: #2b91af">Button</span>();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popupButton.Content = <span style="color: #a31515">"This button on a popup"</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Popup</span> popup = <span style="color: blue">new</span> <span style="color: #2b91af">Popup</span>();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Grid</span> grid = <span style="color: blue">new</span> <span style="color: #2b91af">Grid</span>();</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; grid.Children.Add(popupButton);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.Child = grid;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.PlacementTarget = <span style="color: blue">this</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.PlacementRectangle = <span style="color: blue">new</span> <span style="color: #2b91af">Rect</span>(0, 0, <span style="color: blue">this</span>.ActualWidth, <span style="color: blue">this</span>.ActualHeight - 18);</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.Placement = <span style="color: #2b91af">PlacementMode</span>.Bottom;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.StaysOpen = <span style="color: blue">false</span>;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.IsOpen = <span style="color: blue">true</span>;&nbsp; <span style="color: green">// Second call used to trigger an exception</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.Closed += <span style="color: blue">new</span> <span style="color: #2b91af">EventHandler</span>(popup_Closed);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue">private</span> <span style="color: blue">void</span> popup_Closed(<span style="color: blue">object</span> sender, <span style="color: #2b91af">EventArgs</span> e)</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af">Popup</span> popup = (<span style="color: #2b91af">Popup</span>)sender;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ((<span style="color: #2b91af">Grid</span>)popup.Child).Children.Clear(); <span style="color: green">// will finally clear the control from being in a visual tree</span></p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; popup.Closed -= <span style="color: blue">new</span> <span style="color: #2b91af">EventHandler</span>(popup_Closed);</p> <p style="margin: 0px">&nbsp;</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">&nbsp;&nbsp;&nbsp; }</p> <p style="margin: 0px">}</p> <p style="margin: 0px">&nbsp;</p></div> <div class="wlWriterSmartContent" id="0767317B-992E-4b12-91E0-4F059A8CECA8:723c772e-a3af-4cd2-8619-6d16427aa290" contenteditable="false" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati tags: <a href="http://technorati.com/tags/WPF" rel="tag">WPF</a>, <a href="http://technorati.com/tags/Windows%20Presentation%20Foundation" rel="tag">Windows Presentation Foundation</a>, <a href="http://technorati.com/tags/Popup" rel="tag">Popup</a>, <a href="http://technorati.com/tags/.net%203" rel="tag">.net 3</a></div>