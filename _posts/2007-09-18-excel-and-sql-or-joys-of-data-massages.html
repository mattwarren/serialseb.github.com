---
layout: post
title: Excel and Sql, or the joys of data massages
date: '2007-09-18T14:18:00.001+01:00'

tags:
- ado.net
modified_time: '2007-09-19T14:18:26.564+01:00'
blogger_id: tag:blogger.com,1999:blog-4015568221071268916.post-5870951433756214984
blogger_orig_url: http://serialseb.blogspot.com/2007/09/excel-and-sql-or-joys-of-data-massages.html
---

<p>A problem we encounter too often is&nbsp;extracting data the business stores in an excel spreadsheet. The way some people deal with it&nbsp;is way too often to copy and paste&nbsp;all this in&nbsp;T-SQL code&nbsp;and have long integration scripts.</p> <p>This causes two major problems. The first one is that you rely on your database to&nbsp;integrate data in your application from other systems. The&nbsp;vast majority of products have&nbsp;validation logic and application integrity&nbsp;checks&nbsp;into your application code, and rarely in the database schema.&nbsp;Not only that, but you suddenly expose as a public and exposed system what should remain an implementation detail of your service. In the end, you just made changes to your database structures an order of magnitude more difficult, which now decreases the maintainability of your code.</p> <p>And don't even get me started on testability of T-SQL integration scripts, even with the new VS for database professionals unit testing. It just doesn't add up.</p> <p>That said, the <em>not to do</em> is often the <em>was done</em> and conflicts with the <em>needs to be done by tomorrow</em>. Often enough a project cannot (or doesn't want to) afford a proper integration between their systems, as these projects come in expensive. Often, good enough is what the business wants, and the business controls the budget.</p> <p>And in these cases, you often have to deal with&nbsp;data from Excel and Access. Few people actually know that you can query these files from within your T-SQL code, by using the OPENROWSET command, which gives you whichever table you want to select, through the table name or through a query.</p> <p>In this instance&nbsp;I've just spent a good hour trying to understand why my excel spreadsheet opened through&nbsp;the OpenRecordset would return me a column full of null values when the spreadsheet itself had the correct values.</p> <p>As usual, the answer is hidden in the knowledge base, <a href="http://support.microsoft.com/kb/194124" rel="nofollow">KB194124</a>. Excel tries to guess the datatype of a column, and gives you null if it fails. Rule of thumb, never trust anything that tries being smart.</p> <p>Solution is to switch excel to import mode, by changing the connection string you use to add IMEX=1:</p> <div style="border-right: gray 1px solid; padding-right: 4px; border-top: gray 1px solid; padding-left: 4px; font-size: 8pt; padding-bottom: 4px; margin: 20px 0px 10px; overflow: auto; border-left: gray 1px solid; width: 97.5%; cursor: text; line-height: 12pt; padding-top: 4px; border-bottom: gray 1px solid; font-family: consolas, 'Courier New', courier, monospace; height: 42px; background-color: #f4f4f4; max-height: 200px"><pre style="padding-right: 0px; padding-left: 0px; font-size: 8pt; padding-bottom: 0px; margin: 0em; overflow: visible; width: 100%; color: black; border-top-style: none; line-height: 12pt; padding-top: 0px; font-family: consolas, 'Courier New', courier, monospace; border-right-style: none; border-left-style: none; background-color: #f4f4f4; border-bottom-style: none"><span style="color: #0000ff">SELECT</span> * <span style="color: #0000ff">INTO</span> #xl <span style="color: #0000ff">FROM</span> <span style="color: #0000ff">OPENROWSET</span>(<span style="color: #006080">'Microsoft.Jet.OLEDB.4.0'</span>,
<span style="color: #006080">'Excel 8.0;Database=file.xls;IMEX=1;'</span>, [<span style="color: #006080">'Festival List$'</span>])</pre></div>
<p>And I'm back in business!</p>
<p>[UPDATE: Added some commentary. Also changed the text around a bit, sometimes I realize my English gets fuzzy when I don't proof read before posting. Sorry chaps.]</p>
<div class="wlWriterSmartContent" id="0767317B-992E-4b12-91E0-4F059A8CECA8:5416971a-cbea-4850-82cd-169e454c50d4" contenteditable="false" style="padding-right: 0px; display: inline; padding-left: 0px; padding-bottom: 0px; margin: 0px; padding-top: 0px">Technorati Tags: <a href="http://technorati.com/tags/.net" rel="tag">.net</a>, <a href="http://technorati.com/tags/ado.net" rel="tag">ado.net</a>, <a href="http://technorati.com/tags/sql" rel="tag">sql</a></div>