---
layout: post
title: HttpResponse.Flush forces Chunked transfer…
date: '2008-10-05T22:22:00.001+01:00'
author: Sebastien Lambla
tags: 
modified_time: '2008-10-05T22:22:35.693+01:00'
blogger_id: tag:blogger.com,1999:blog-4015568221071268916.post-4694369533113225208
blogger_orig_url: http://serialseb.blogspot.com/2008/10/httpresponseflush-forces-chunked.html
---

<p>That one took me quite a while to understand. I’ve been building the integration tests for OpenRasta, a bunch of classes that configure a full web-server and run a real request-response scenario. This should hopefully help in limiting regressions, and may also be used in the future to ensure continuous compatibility with IIS6 on plain .net 2.0.</p>  <p>I’m leveraging the kernel http support present since Windows XP SP2 to create an http listener dynamically and initializing the asp.net runtime inside it, though the very useful <a href="msdn.microsoft.com/System.Net.HttpListener">HttpListener</a> class.</p>  <p>After a lot of debugging, I discovered that my test was failing because of an encoding issue. Instead of returning the content that was sent to it by OpenRasta, an 18 bytes string, I ended up with much more than that, with line breaks in the middle. A quick look at the returned headers and it became very obvious that the system was sending me back chunked-encoding, a process by which the data is sent in blocks, each prefixed with the size, and suffixed with entity headers. The thing is, there is no support at all yet in OpenRasta for chunked encoding.</p>  <p>Here is the block of code causing all thesetroubles.</p>  <div style="font-size: 10pt; background: #252525; color: #e0e0e0; font-family: consolas, courier new">   <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #00bfff">public</span> <span style="color: #00bfff">void</span> ProcessRequest(<span style="color: #00d2d2">HttpContext</span> context)</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <span style="color: #92e4d6">IRastaContext</span> rastaContext <span style="color: #a6a0e0">=</span> <span style="color: #00d2d2">RastaConfiguration</span><span style="color: #a6a0e0">.</span>GetService<span style="color: #a6a0e0">&lt;</span><span style="color: #92e4d6">IRastaContext</span><span style="color: #a6a0e0">&gt;</span>();</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; rastaContext<span style="color: #a6a0e0">.</span>SetContext(context);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; _pipeline<span style="color: #a6a0e0">.</span>Run(rastaContext);</p>    <p style="margin: 0px">&#160;</p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; context<span style="color: #a6a0e0">.</span>Response<span style="color: #a6a0e0">.</span>Flush(); <span style="color: #bdb76b">// &lt;!-- see that one?</span></p>    <p style="margin: 0px">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p> </div>  <p></p>  <p>As you can see, I was calling Flush on the HttpResponse object in the IHttpHandler that runs the OpenRasta pipeline. I quite understand the reasoning behind switching transparently to chunked encoding when requesting a data flush, you want to clear the data queue by sending it to the client, but you do not know yet how much data you will send later. At that point, using Content-Length is not possible, and chunked encoding is the only way to achieve the desired result.</p>  <p>Looking at the msdn documentation for <a href="http://msdn.microsoft.com/system.web.httpresponse.flush">HttpResponse.Flush</a> you will notice there is no mention of that behavior. But not to worry, other developers thought it may come handy to document, and you will find the following on the <a href="http://www.go-mono.com/docs/index.aspx?link=M%3ASystem.Web.HttpResponse.Flush">mono documentation</a>.</p>  <blockquote>   <blockquote>HttpResponse by default will buffer all of the output before it is sent to the client. To control the delivery of the data developers can use this method (or alternatively set the <a href="http://www.go-mono.com/docs/monodoc.ashx?link=P%3aSystem.Web.HttpResponse.Buffer">HttpResponse.Buffer</a> property to false).       <p>If chunked transfers are enabled for this response, this will try to use the chunked transfer.</p>   </blockquote> </blockquote>  <p>Elementary, my dear Watson.</p>  